<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
  <title>LoveChat ‚Äî Private Room</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --rose:#FF3366; --blush:#FF6B8A; --gold:#FFB347;
      --deep:#0D0014; --panel:#160020;
      --surface:rgba(255,255,255,0.04); --border:rgba(255,255,255,0.07);
      --text:rgba(255,255,255,0.88); --muted:rgba(255,255,255,0.4);
      --out-bg:linear-gradient(135deg,#FF3366,#FF1744); --in-bg:rgba(255,255,255,0.07);
    }
    html,body{height:100%;overflow:hidden;}
    body{font-family:'DM Sans',sans-serif;background:var(--deep);color:var(--text);display:flex;flex-direction:column;}
    body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 60% 50% at 20% 10%,rgba(255,51,102,.12) 0%,transparent 60%),radial-gradient(ellipse 40% 30% at 80% 80%,rgba(255,107,138,.08) 0%,transparent 60%);pointer-events:none;z-index:0;}
    body.protected{-webkit-user-select:none;-moz-user-select:none;user-select:none;}

    .hearts-layer{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
    .float-heart{position:absolute;bottom:-40px;animation:hFloat linear infinite;opacity:0;font-size:14px;user-select:none;}
    @keyframes hFloat{0%{transform:translateY(0) rotate(0);opacity:0;}8%{opacity:.35;}92%{opacity:.2;}100%{transform:translateY(-105vh) rotate(540deg);opacity:0;}}

    .video-hearts{position:absolute;inset:0;pointer-events:none;z-index:5;overflow:hidden;}
    .video-heart{position:absolute;bottom:-60px;font-size:32px;animation:videoHeartFloat 6s ease-out forwards;opacity:0;}
    @keyframes videoHeartFloat{0%{opacity:0;transform:translateY(0) rotate(0) scale(0.5);}10%{opacity:1;}90%{opacity:0.7;}100%{opacity:0;transform:translateY(-120vh) rotate(360deg) scale(1.2);}}

    .app-wrapper{position:relative;z-index:1;display:flex;flex-direction:column;height:100vh;max-height:100dvh;}

    .chat-header{flex-shrink:0;display:flex;align-items:center;padding:12px 16px;background:rgba(255,255,255,.04);backdrop-filter:blur(30px);border-bottom:1px solid var(--border);gap:10px;}
    .back-btn{width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,255,255,.07);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background .2s;}
    .back-btn:hover{background:rgba(255,255,255,.12);}
    .partner-avatar-wrap{position:relative;flex-shrink:0;}
    .partner-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,rgba(255,51,102,.25),rgba(255,107,138,.15));border:2px solid rgba(255,51,102,.3);display:flex;align-items:center;justify-content:center;font-size:22px;transition:border-color .4s;}
    .partner-avatar.online{border-color:#4ADE80;box-shadow:0 0 0 2px rgba(74,222,128,.2);}
    .online-dot{position:absolute;bottom:1px;right:1px;width:11px;height:11px;border-radius:50%;background:#4ADE80;border:2px solid var(--deep);opacity:0;transition:opacity .4s;}
    .online-dot.show{opacity:1;}
    .partner-info{flex:1;min-width:0;}
    .partner-name{font-size:15px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .partner-status{font-size:11px;color:var(--muted);height:16px;overflow:hidden;}
    .partner-status.online-text{color:#4ADE80;}
    .header-actions{display:flex;gap:6px;}
    .hdr-btn{width:36px;height:36px;border-radius:50%;border:none;background:rgba(255,255,255,.06);color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s,color .2s,transform .15s; font-weight: bold;}
    .hdr-btn:hover{background:rgba(255,255,255,.1);color:var(--text);transform:scale(1.08);}
    .hdr-btn.active{background:rgba(255,51,102,.2);color:var(--rose);}
    .hdr-btn.video-active{background:linear-gradient(135deg,var(--rose),#FF1744);color:#fff;box-shadow:0 4px 16px rgba(255,51,102,.4);}
    .hdr-btn svg{width:18px;height:18px;}

    .music-bar{flex-shrink:0;display:flex;align-items:center;gap:10px;padding:8px 16px;background:rgba(255,51,102,.06);border-bottom:1px solid rgba(255,51,102,.1);transition:all .3s;}
    .music-bar.hidden{display:none;}
    .music-note-anim{font-size:18px;animation:noteBounce 0.8s ease infinite;}
    @keyframes noteBounce{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-4px) scale(1.15);}}
    .music-info{flex:1;min-width:0;}
    .music-title{font-size:12px;font-weight:600;color:var(--rose);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .music-artist{font-size:10px;color:var(--muted);}
    .music-controls{display:flex;gap:6px;align-items:center;}
    .mc-btn{width:28px;height:28px;border-radius:50%;border:none;background:rgba(255,255,255,.08);color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s,transform .15s;}
    .mc-btn:hover{background:rgba(255,51,102,.3);transform:scale(1.1);}
    .mc-btn.play{background:var(--rose);color:#fff;width:32px;height:32px;box-shadow:0 3px 12px rgba(255,51,102,.4);}
    .mc-btn svg{width:14px;height:14px;}
    .mc-btn.play svg{width:16px;height:16px;}
    .music-progress{flex:1;height:3px;background:rgba(255,255,255,.1);border-radius:2px;cursor:pointer;max-width:80px;}
    .music-progress-fill{height:100%;background:var(--rose);border-radius:2px;transition:width .5s linear;}
    .music-vol{cursor:pointer;opacity:.6;transition:opacity .2s;display:flex;align-items:center;}
    .music-vol:hover{opacity:1;}
    .music-vol svg{width:16px;height:16px;}

    .messages-area{flex:1;overflow-y:auto;overflow-x:hidden;padding:12px 14px 6px;display:flex;flex-direction:column;gap:5px;scroll-behavior:smooth;}
    .messages-area::-webkit-scrollbar{width:3px;}
    .messages-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px;}

    .date-divider{display:flex;align-items:center;gap:12px;padding:8px 20px;margin:8px 0;}
    .date-divider::before,.date-divider::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);}
    .date-divider span{font-size:11px;color:var(--muted);letter-spacing:.5px;white-space:nowrap;padding:4px 12px;background:rgba(255,255,255,.04);border-radius:10px;border:1px solid var(--border);}

    .msg-row{display:flex;align-items:flex-end;gap:8px;animation:msgAppear .32s cubic-bezier(.34,1.56,.64,1) both;}
    @keyframes msgAppear{from{opacity:0;transform:scale(.85) translateY(10px);}to{opacity:1;transform:none;}}
    .msg-row.out{flex-direction:row-reverse;}
    .msg-av{width:28px;height:28px;border-radius:50%;background:rgba(255,51,102,.15);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-bottom:4px;}
    .msg-row.out .msg-av{display:none;}
    .bubble-wrap{display:flex;flex-direction:column;max-width:min(72%,360px);}
    .msg-row.out .bubble-wrap{align-items:flex-end;}
    .sender-name{font-size:10px;color:var(--blush);margin-bottom:2px;padding-left:10px;font-weight:600;}
    .msg-row.out .sender-name{display:none;}
    .bubble{padding:9px 13px;border-radius:18px;font-size:14px;line-height:1.55;word-break:break-word;}
    .bubble.in{background:var(--in-bg);border-bottom-left-radius:4px;color:var(--text);backdrop-filter:blur(10px);border:1px solid var(--border);}
    .bubble.out{background:var(--out-bg);border-bottom-right-radius:4px;color:#fff;box-shadow:0 4px 16px rgba(255,51,102,.3);}
    .msg-meta{display:flex;align-items:center;gap:3px;margin-top:3px;justify-content:flex-end;}
    .msg-time-label{font-size:10px;color:var(--muted);}
    .bubble.out .msg-time-label{color:rgba(255,255,255,.55);}
    .checkmarks{font-size:12px;color:rgba(255,255,255,.5);transition:color .3s;}
    .checkmarks.seen{color:#60CFFF;}

    .typing-row{display:flex;align-items:flex-end;gap:8px;opacity:0;transform:translateY(8px);transition:opacity .3s,transform .3s;height:0;overflow:hidden;pointer-events:none;}
    .typing-row.show{opacity:1;transform:none;height:auto;padding-bottom:4px;}
    .typing-bubble{background:var(--in-bg);border:1px solid var(--border);border-radius:18px;border-bottom-left-radius:4px;padding:11px 14px;display:flex;gap:5px;align-items:center;backdrop-filter:blur(10px);}
    .typing-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:typingBounce 1.2s ease infinite;}
    .typing-dot:nth-child(2){animation-delay:.2s;}.typing-dot:nth-child(3){animation-delay:.4s;}
    @keyframes typingBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-6px);}}

    .input-area{flex-shrink:0;padding:8px 12px 12px;background:rgba(255,255,255,.03);backdrop-filter:blur(20px);border-top:1px solid var(--border);}
    .input-bar{display:flex;align-items:flex-end;gap:8px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.09);border-radius:26px;padding:6px 6px 6px 14px;transition:border-color .25s,box-shadow .25s;}
    .input-bar:focus-within{border-color:rgba(255,51,102,.5);box-shadow:0 0 0 3px rgba(255,51,102,.08);}
    .emoji-btn{width:32px;height:32px;background:none;border:none;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;opacity:.55;flex-shrink:0;margin-bottom:2px;transition:opacity .2s,transform .2s;}
    .emoji-btn:hover{opacity:1;transform:scale(1.12);}
    #msgInput{flex:1;background:none;border:none;outline:none;color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif;line-height:1.5;resize:none;max-height:96px;overflow-y:auto;padding:5px 0;scrollbar-width:thin;}
    #msgInput::-webkit-scrollbar{width:2px;}
    #msgInput::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:2px;}
    #msgInput::placeholder{color:var(--muted);}
    .send-btn{width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--rose),#FF1744);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 14px rgba(255,51,102,.4);}
    .send-btn:hover{transform:scale(1.08);box-shadow:0 6px 20px rgba(255,51,102,.55);}
    .send-btn:active{transform:scale(.95);}
    .send-btn svg{width:18px;height:18px;stroke:#fff;fill:none;}

    .sys-msg{text-align:center;padding:5px 16px;margin:4px auto;}
    .sys-msg span{font-size:11px;color:var(--muted);background:rgba(255,255,255,.04);border:1px solid var(--border);padding:4px 12px;border-radius:10px;display:inline-block;}

    .emoji-panel{position:absolute;bottom:70px;left:12px;background:rgba(18,0,28,.98);border:1px solid rgba(255,255,255,.1);border-radius:18px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.6);display:none;backdrop-filter:blur(20px);z-index:20;width:272px;}
    .emoji-panel.show{display:block;}
    .emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:4px;}
    .ep-emoji{font-size:20px;text-align:center;cursor:pointer;padding:5px;border-radius:7px;transition:background .15s,transform .15s;}
    .ep-emoji:hover{background:rgba(255,255,255,.08);transform:scale(1.2);}

    .toast{position:fixed;top:22px;left:50%;transform:translateX(-50%) translateY(-80px);background:rgba(22,0,32,.95);border:1px solid rgba(255,51,102,.3);border-radius:12px;padding:10px 18px;font-size:13px;color:var(--text);z-index:200;white-space:nowrap;transition:transform .35s cubic-bezier(.34,1.56,.64,1),opacity .3s;backdrop-filter:blur(20px);box-shadow:0 12px 40px rgba(0,0,0,.4);opacity:0;}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}

    #waitingOverlay,#joinOverlay,#roomFullOverlay,#ipBlockedOverlay,#exitConfirmModal{position:fixed;inset:0;z-index:50;background:rgba(13,0,20,.94);backdrop-filter:blur(20px);display:flex;align-items:center;justify-content:center;padding:24px;}
    #waitingOverlay.hidden,#joinOverlay.hidden{display:none;}
    #roomFullOverlay,#ipBlockedOverlay,#exitConfirmModal{display:none;}
    #roomFullOverlay.show,#ipBlockedOverlay.show,#exitConfirmModal.show{display:flex;}

    .waiting-card,.join-card{text-align:center;max-width:360px;}
    .waiting-heart{font-size:72px;display:block;animation:pulseHeart 1.4s ease-in-out infinite;margin-bottom:20px;}
    @keyframes pulseHeart{0%,100%{transform:scale(1);}50%{transform:scale(1.18);}}
    .waiting-card h2,.join-card h2{font-family:'Playfair Display',serif;font-size:26px;margin-bottom:10px;color:#fff;}
    .waiting-card p,.join-card p{color:var(--muted);font-size:14px;line-height:1.65;margin-bottom:24px;}

    .join-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,51,102,.2);border-radius:26px;padding:36px 28px;max-width:370px;width:100%;}
    .join-card .big-emoji{font-size:56px;display:block;margin-bottom:18px;}
    .join-input{width:100%;padding:13px 16px;border-radius:12px;border:1.5px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);color:var(--text);font-size:14px;font-family:'DM Sans',sans-serif;outline:none;margin-bottom:12px;transition:border-color .2s,box-shadow .2s;}
    .join-input:focus{border-color:rgba(255,51,102,.5);box-shadow:0 0 0 3px rgba(255,51,102,.1);}
    .join-avatars{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:20px;}
    .jav-btn{width:42px;height:42px;border-radius:50%;border:2px solid transparent;background:rgba(255,255,255,.06);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:border-color .2s,transform .2s;}
    .jav-btn:hover,.jav-btn.active{border-color:var(--rose);transform:scale(1.12);}
    .join-btn{width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--rose),#FF1744);color:#fff;font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;box-shadow:0 6px 22px rgba(255,51,102,.4);transition:transform .2s,box-shadow .2s;}
    .join-btn:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,51,102,.5);}

    .link-share-box{background:rgba(255,255,255,.05);border:1px solid rgba(255,51,102,.2);border-radius:14px;padding:14px 18px;margin-bottom:18px;text-align:left;}
    .lsb-label{font-size:10px;text-transform:uppercase;letter-spacing:1.2px;color:var(--rose);font-weight:600;margin-bottom:6px;}
    .lsb-url{font-size:12px;color:rgba(255,255,255,.5);word-break:break-all;font-family:monospace;line-height:1.5;}
    .lsb-copy{width:100%;margin-top:10px;padding:11px;border-radius:10px;border:none;background:var(--rose);color:#fff;font-size:13px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;transition:transform .2s,opacity .2s;}
    .lsb-copy:hover{opacity:.9;transform:translateY(-1px);}

    .exit-modal-card{background:rgba(22,0,32,.98);border:1px solid rgba(255,51,102,.3);border-radius:24px;padding:36px 32px;max-width:360px;text-align:center;}
    .exit-modal-card h2{font-family:'Playfair Display',serif;font-size:24px;color:#fff;margin:16px 0 12px;}
    .exit-modal-card p{color:var(--muted);font-size:14px;line-height:1.7;margin-bottom:24px;}
    .exit-btns{display:flex;gap:12px;}
    .exit-btn{flex:1;padding:13px;border-radius:12px;border:none;font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;transition:transform .2s,opacity .2s;}
    .exit-btn-cancel{background:rgba(255,255,255,.1);color:#fff;}
    .exit-btn-end{background:var(--rose);color:#fff;}
    .exit-btn:hover{transform:translateY(-1px);opacity:.95;}

    #videoCallOverlay{position:fixed;inset:0;z-index:80;background:#000;display:none;flex-direction:column;}
    #videoCallOverlay.show{display:flex;}
    .video-container{position:relative;flex:1;background:#0a0a0a;overflow:hidden;}
    #remoteVideo{width:100%;height:100%;object-fit:cover;background:#111;}
    #localVideo{position:absolute;top:16px;right:16px;width:120px;height:160px;object-fit:cover;border-radius:16px;border:2px solid rgba(255,255,255,.2);box-shadow:0 8px 30px rgba(0,0,0,.6);cursor:pointer;transition:transform .2s;z-index:2;}
    #localVideo:hover{transform:scale(1.04);}
    .video-placeholder{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;}
    .video-placeholder .big-av{font-size:80px;}
    .call-status-bar{position:absolute;top:0;left:0;right:0;padding:14px 20px;background:linear-gradient(180deg,rgba(0,0,0,.7),transparent);display:flex;align-items:center;gap:12px;z-index:3;}
    .call-partner-info{flex:1;}
    .call-partner-name{color:#fff;font-size:15px;font-weight:600;}
    .call-timer{color:rgba(255,255,255,.6);font-size:12px;font-family:monospace;}
    .call-controls{position:absolute;bottom:0;left:0;right:0;padding:20px 24px 32px;background:linear-gradient(0deg,rgba(0,0,0,.85),transparent);display:flex;align-items:center;justify-content:center;gap:16px;z-index:3;}
    .ctrl-btn{width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s;background:rgba(255,255,255,.15);color:#fff;}
    .ctrl-btn:hover{transform:scale(1.08);}
    .ctrl-btn.off{background:rgba(255,255,255,.06);opacity:.6;}
    .ctrl-btn.end{background:#FF3B30;box-shadow:0 6px 24px rgba(255,59,48,.5);}
    .ctrl-btn.end:hover{box-shadow:0 10px 32px rgba(255,59,48,.7);}
    .ctrl-btn svg{width:24px;height:24px;}

    #incomingCallModal,#callingModal{position:fixed;inset:0;z-index:90;background:rgba(0,0,0,.85);backdrop-filter:blur(20px);display:none;align-items:center;justify-content:center;padding:24px;}
    #incomingCallModal.show,#callingModal.show{display:flex;}
    .incoming-card,.calling-card{text-align:center;background:rgba(22,0,32,.95);border:1px solid rgba(255,51,102,.3);border-radius:28px;padding:40px 32px;max-width:320px;width:100%;}
    .incoming-av{font-size:64px;display:block;margin-bottom:16px;animation:ringing 1s ease infinite;}
    @keyframes ringing{0%,100%{transform:rotate(0);}20%{transform:rotate(-15deg);}40%{transform:rotate(15deg);}60%{transform:rotate(-10deg);}80%{transform:rotate(10deg);}}
    .incoming-name,.calling-name{font-family:'Playfair Display',serif;font-size:22px;color:#fff;margin-bottom:6px;}
    .incoming-sub,.calling-sub{color:var(--muted);font-size:13px;margin-bottom:28px;}
    .incoming-btns{display:flex;gap:16px;justify-content:center;}
    .ic-btn{width:64px;height:64px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s;}
    .ic-btn:hover{transform:scale(1.1);}
    .ic-accept{background:#30D158;box-shadow:0 6px 24px rgba(48,209,88,.4);}
    .ic-reject{background:#FF3B30;box-shadow:0 6px 24px rgba(255,59,48,.4);}
    .ic-btn svg{width:28px;height:28px;stroke:#fff;fill:none;}
    .calling-pulse{width:100px;height:100px;border-radius:50%;background:rgba(255,51,102,.15);margin:0 auto 20px;display:flex;align-items:center;justify-content:center;animation:callPulse 1.5s ease infinite;font-size:40px;}
    @keyframes callPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,51,102,.4);}50%{box-shadow:0 0 0 24px rgba(255,51,102,0);}}
    .cancel-call-btn{padding:14px 36px;background:#FF3B30;color:#fff;border:none;border-radius:50px;font-size:14px;font-weight:600;font-family:'DM Sans',sans-serif;cursor:pointer;box-shadow:0 6px 20px rgba(255,59,48,.4);transition:transform .2s;}
    .cancel-call-btn:hover{transform:translateY(-2px);}

    @media(min-width:768px){.app-wrapper{max-width:480px;margin:0 auto;border-left:1px solid var(--border);border-right:1px solid var(--border);} #videoCallOverlay,.video-container{max-width:480px;margin:0 auto;} #localVideo{width:100px;height:140px;}}
    @media(max-width:480px){.bubble{font-size:13px;}}
  </style>
</head>
<body class="protected">

<div class="hearts-layer" id="heartsLayer"></div>
<div class="toast" id="toast"></div>

<div id="roomFullOverlay">
  <div style="text-align:center;">
    <span style="font-size:64px">üíî</span>
    <h2 style="font-family:'Playfair Display',serif;font-size:26px;margin:18px 0 10px;color:#fff;">Room is Full</h2>
    <p style="color:var(--muted);max-width:300px;line-height:1.7;font-size:14px;">This private chat already has two people.</p>
    <a href="/" style="margin-top:24px;padding:12px 28px;background:var(--rose);color:#fff;border-radius:50px;text-decoration:none;font-weight:600;font-size:14px;display:inline-block;">Create My Own Room</a>
  </div>
</div>

<div id="ipBlockedOverlay">
  <div style="text-align:center;">
    <img src="/no.gif" alt="Blocked" style="width:200px; height:200px;">

    <h2 style="font-family:'Playfair Display',serif;font-size:26px;margin:18px 0 10px;color:#fff;">Already Connected</h2>
    <p style="color:var(--muted);max-width:320px;line-height:1.7;font-size:14px;margin-bottom:24px;">You are already connected to this room from this device.</p>
    <a href="/" style="padding:12px 28px;background:var(--rose);color:#fff;border-radius:50px;text-decoration:none;font-weight:600;font-size:14px;display:inline-block;">Go Home</a>
  </div>
</div>

<div id="joinOverlay">
  <div class="join-card">
    <span class="big-emoji">üíù</span>
    <h2>You're Invited!</h2>
    <p>Someone special is waiting. Enter your name to join.</p>
    <input class="join-input" id="joinName" placeholder="Your name..." maxlength="20"/>
    <div class="join-avatars" id="joinAvatarPicker"></div>
    <button class="join-btn" id="joinBtn">üíï Join the Chat</button>
  </div>
</div>

<div id="waitingOverlay" class="hidden">
  <div class="waiting-card">
    <span class="waiting-heart">üíù</span>
    <h2>Waiting for Your Valentine...</h2>
    <p>Share this link. The chat begins when they arrive.</p>
    <div class="link-share-box">
      <div class="lsb-label">Your Private Link</div>
      <div class="lsb-url" id="shareUrl"></div>
      <button class="lsb-copy" id="copyShareLink">üìã Copy Link</button>
    </div>
  </div>
</div>

<div id="exitConfirmModal">
  <div class="exit-modal-card">
    <span style="font-size:48px;">üíî</span>
    <h2>End This Chat?</h2>
    <p>If you leave, this conversation will end for both of you. Are you sure?</p>
    <div class="exit-btns">
      <button class="exit-btn exit-btn-cancel" id="exitCancelBtn">Stay</button>
      <button class="exit-btn exit-btn-end" id="exitConfirmBtn">End Chat</button>
    </div>
  </div>
</div>

<div id="incomingCallModal">
  <div class="incoming-card">
    <span class="incoming-av" id="callerAvatar">üíù</span>
    <div class="incoming-name" id="callerName">Someone</div>
    <div class="incoming-sub">is calling you...</div>
    <div class="incoming-btns">
      <button class="ic-btn ic-reject" id="rejectCallBtn"><i data-feather="phone-off"></i></button>
      <button class="ic-btn ic-accept" id="acceptCallBtn"><i data-feather="video"></i></button>
    </div>
  </div>
</div>

<div id="callingModal">
  <div class="calling-card">
    <div class="calling-pulse" id="callingPulseAv">üíù</div>
    <div class="calling-name" id="callingName">Calling...</div>
    <div class="calling-sub">Ringing your Valentine...</div>
    <button class="cancel-call-btn" id="cancelCallBtn">Cancel Call</button>
  </div>
</div>

<div id="videoCallOverlay">
  <div class="video-container">
    <div class="video-hearts" id="videoHearts"></div>
    <div class="video-placeholder" id="remotePlaceholder">
      <div class="big-av" id="remoteAvEl">üíù</div>
      <p id="remotePlaceholderText" style="color:rgba(255,255,255,.4);font-size:14px;">Connecting video...</p>
    </div>
    <video id="remoteVideo" autoplay playsinline style="display:none;"></video>
    <video id="localVideo" autoplay playsinline muted></video>
    <div class="call-status-bar">
      <div class="call-partner-info">
        <div class="call-partner-name" id="callPartnerName">Connecting...</div>
        <div class="call-timer" id="callTimer">00:00</div>
      </div>
    </div>
    <div class="call-controls">
      <button class="ctrl-btn" id="toggleCamBtn" title="Camera"><i data-feather="video"></i></button>
      <button class="ctrl-btn" id="flipCamBtn" title="Switch Camera" style="display:none;"><i data-feather="refresh-cw"></i></button>
      <button class="ctrl-btn end" id="endCallBtn" title="End Call"><i data-feather="phone-off"></i></button>
      <button class="ctrl-btn" id="toggleMicBtn" title="Mute"><i data-feather="mic"></i></button>
    </div>
  </div>
</div>

<div class="app-wrapper" id="appWrapper">
  <div class="chat-header">
    <button class="back-btn" id="backBtn"><i data-feather="arrow-left"></i></button>
    <div class="partner-avatar-wrap">
      <div class="partner-avatar" id="partnerAvatar">üíù</div>
      <div class="online-dot" id="onlineDot"></div>
    </div>
    <div class="partner-info">
      <div class="partner-name" id="partnerName">Private Chat</div>
      <div class="partner-status" id="partnerStatus">Waiting...</div>
    </div>
    <div class="header-actions">
      <button class="hdr-btn" id="videoCallBtn" title="Video Call"><i data-feather="video"></i></button>
      <button class="hdr-btn" id="musicToggleBtn" title="Toggle Music"><i data-feather="music"></i></button>
      <button class="hdr-btn" id="muteBtn" title="Toggle Notifications"><i data-feather="volume-2"></i></button>
    </div>
  </div>

  <div class="music-bar hidden" id="musicBar">
    <span class="music-note-anim" id="musicNoteIcon">üéµ</span>
    <div class="music-info">
      <div class="music-title" id="musicTitle">Loading...</div>
      <div class="music-artist" id="musicArtist">Valentine's Playlist</div>
    </div>
    <div class="music-controls">
      <button class="mc-btn" id="prevTrackBtn" title="Previous"><i data-feather="skip-back"></i></button>
      <button class="mc-btn play" id="playPauseBtn" title="Play/Pause"><i data-feather="play"></i></button>
      <button class="mc-btn" id="nextTrackBtn" title="Next"><i data-feather="skip-forward"></i></button>
    </div>
    <div class="music-progress" id="musicProgress">
      <div class="music-progress-fill" id="musicProgressFill" style="width:0%"></div>
    </div>
    <span class="music-vol" id="musicVolBtn" title="Mute Music"><i data-feather="volume-2"></i></span>
  </div>

  <div class="messages-area" id="messagesArea">
    <div class="date-divider"><span>üíï Valentine's Day ¬∑ Private Room</span></div>
    <div class="sys-msg"><span>üîí Private, encrypted conversation</span></div>
    <div class="typing-row" id="typingRow">
      <div class="msg-av" id="typingAv">üíù</div>
      <div class="typing-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
    </div>
  </div>

  <div class="emoji-panel" id="emojiPanel">
    <div class="emoji-grid" id="emojiGrid"></div>
  </div>

  <div class="input-area">
    <div class="input-bar">
      <button class="emoji-btn" id="emojiToggleBtn" title="Emoji">üòä</button>
      <textarea id="msgInput" placeholder="Type a message..." rows="1" maxlength="500"></textarea>
      <button class="send-btn" id="sendBtn" title="Send (Enter)"><i data-feather="send"></i></button>
    </div>
  </div>
</div>

<audio id="bgMusic" loop preload="auto"></audio>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// Security
(function() {
  document.addEventListener('contextmenu', e => { e.preventDefault(); return false; });
  document.addEventListener('keydown', e => {
    const k = e.key || e.keyCode;
    if (k==='F12'||k===123||(e.ctrlKey&&e.shiftKey&&'IJCijc'.includes(k))||(e.ctrlKey&&(k==='u'||k==='U'))||(e.metaKey&&e.altKey&&(k==='i'||k==='I'))) {
      e.preventDefault(); e.stopPropagation(); return false;
    }
  });
  const threshold = 160; let devOpen = false;
  const checkDevTools = () => {
    const widthDiff = window.outerWidth - window.innerWidth > threshold;
    const heightDiff = window.outerHeight - window.innerHeight > threshold;
    if ((widthDiff || heightDiff) && !devOpen) {
      devOpen = true;
      document.body.innerHTML = '<div style="position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;"><span style="font-size:60px">üíî</span><p style="color:#FF3366;font-size:20px;font-family:sans-serif;font-weight:bold;">Access Denied</p></div>';
    }
  };
  setInterval(checkDevTools, 1000);
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') document.body.style.filter = 'brightness(0)';
    else setTimeout(() => document.body.style.filter = '', 100);
  });
  document.addEventListener('selectstart', e => e.preventDefault());
  document.addEventListener('dragstart', e => e.preventDefault());
})();

// State
const roomId = window.location.pathname.split('/room/')[1];
const urlParams = new URLSearchParams(window.location.search);
let myName = urlParams.get('name') || '';
let myAvatar = urlParams.get('avatar') || 'üíù';
let partnerName = 'Waiting...', partnerAvEmoji = 'üíù';
let isMuted = false, isMusicMuted = false;
let typingTimer = null, isTypingNow = false;
let socket, isCreator = !!(myName), partnerOnline = false, musicEnabled = false;
let callerId = null;

// Hearts
const heartsLayer = document.getElementById('heartsLayer');
const heartSet = ['‚ù§Ô∏è','üíï','üíñ','üíó','üåπ','‚ú®','üí´','üå∏'];
function spawnHeart() {
  const h = document.createElement('div');
  h.className = 'float-heart';
  h.textContent = heartSet[Math.floor(Math.random() * heartSet.length)];
  h.style.left = Math.random() * 100 + 'vw';
  h.style.animationDuration = (10 + Math.random() * 14) + 's';
  h.style.fontSize = (10 + Math.random() * 14) + 'px';
  heartsLayer.appendChild(h);
  setTimeout(() => h.remove(), 24000);
}
setInterval(spawnHeart, 1400);
[0,400,800,1200].forEach(d => setTimeout(spawnHeart, d));

// Video floating hearts
let videoHeartInterval = null;
function spawnVideoHeart() {
  const h = document.createElement('div');
  h.className = 'video-heart';
  h.textContent = ['‚ù§Ô∏è','üíï','üíñ','üåπ','‚ú®'][Math.floor(Math.random()*5)];
  h.style.left = Math.random() * 100 + '%';
  document.getElementById('videoHearts').appendChild(h);
  setTimeout(() => h.remove(), 6000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ROMANTIC MUSIC PLAYER - FIXED VERSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TRACKS = [
  { title: 'Ab Jo Mile', artist: 'Vishal Mishra & Sachin-Jigar', src: '/music/Ab Jo Mile.mp3' },
];

let currentTrack = 0;
let musicPlaying = false;
let isMusicLeader = false;
const bgMusic = document.getElementById('bgMusic');
bgMusic.volume = 0.3; // Increased from 0.01 for audible playback

// Load track with error handling
function loadTrack(idx, autoPlay = false, startTime = 0) {
  if (idx >= TRACKS.length) idx = 0;
  if (idx < 0) idx = TRACKS.length - 1;
  
  currentTrack = idx;
  const track = TRACKS[idx];
  
  // Reset error handler first
  bgMusic.onerror = null;
  
  bgMusic.src = track.src;
  bgMusic.currentTime = startTime;
  
  document.getElementById('musicTitle').textContent = track.title;
  document.getElementById('musicArtist').textContent = track.artist;
  document.getElementById('musicNoteIcon').textContent = 'üéµ';
  
  // Handle loading errors
  bgMusic.onerror = () => {
    console.warn(`Track ${idx} failed to load`);
    document.getElementById('musicTitle').textContent = 'Track unavailable';
    document.getElementById('musicArtist').textContent = 'Check /music/ folder';
    document.getElementById('musicNoteIcon').textContent = '‚ö†Ô∏è';
  };
  
  // Handle successful load
  bgMusic.oncanplaythrough = () => {
    console.log('Track loaded successfully');
    if (autoPlay && musicEnabled) {
      bgMusic.play().catch(err => {
        console.error('Autoplay failed:', err);
        musicPlaying = false;
        updatePlayBtn();
      });
    }
  };
  
  if (autoPlay && musicEnabled) {
    musicPlaying = true;
    bgMusic.play().catch(err => {
      console.error('Play failed:', err);
      musicPlaying = false;
      updatePlayBtn();
    });
  }
  
  updatePlayBtn();
}

function updatePlayBtn() {
  const btn = document.getElementById('playPauseBtn');
  const icon = btn.querySelector('i');
  if (icon) {
    icon.setAttribute('data-feather', musicPlaying ? 'pause' : 'play');
    feather.replace();
  } else {
    // If no icon exists, create it
    btn.innerHTML = `<i data-feather="${musicPlaying ? 'pause' : 'play'}"></i>`;
    feather.replace();
  }
}

function updateMusicProgress() {
  if (!bgMusic.duration || isNaN(bgMusic.duration)) return;
  const pct = (bgMusic.currentTime / bgMusic.duration) * 100;
  document.getElementById('musicProgressFill').style.width = pct + '%';
}

function broadcastMusicState() {
  if (!socket || !isMusicLeader) return;
  socket.emit('music-control', {
    roomId,
    trackIndex: currentTrack,
    playing: musicPlaying,
    currentTime: bgMusic.currentTime || 0
  });
}

// Music event listeners
bgMusic.addEventListener('timeupdate', updateMusicProgress);

bgMusic.addEventListener('ended', () => {
  console.log('Track ended, moving to next');
  currentTrack = (currentTrack + 1) % TRACKS.length;
  loadTrack(currentTrack, musicPlaying, 0);
  if (isMusicLeader) {
    broadcastMusicState();
  }
});

bgMusic.addEventListener('play', () => {
  musicPlaying = true;
  updatePlayBtn();
});

bgMusic.addEventListener('pause', () => {
  musicPlaying = false;
  updatePlayBtn();
});

// Music control functions
function toggleMusicPlayback() {
  if (!isMusicLeader) {
    showToast('Only the room creator can control music');
    return;
  }
  
  if (musicPlaying) {
    bgMusic.pause();
    musicPlaying = false;
  } else {
    bgMusic.play().then(() => {
      musicPlaying = true;
      updatePlayBtn();
    }).catch(err => {
      console.error('Play failed:', err);
      showToast('‚ùå Playback failed');
      musicPlaying = false;
      updatePlayBtn();
    });
  }
  
  updatePlayBtn();
  broadcastMusicState();
}

// Apply synced music state from server
function applyMusicSync({ trackIndex, playing, time, elapsed, currentTime }) {
  console.log('Applying music sync:', { trackIndex, playing, time, elapsed, currentTime });
  
  // Handle both formats: time+elapsed or currentTime
  const adjustedTime = currentTime !== undefined ? currentTime : ((time || 0) + (elapsed || 0));
  currentTrack = trackIndex;
  musicPlaying = playing;
  
  loadTrack(trackIndex, false, adjustedTime);
  
  if (playing && musicEnabled) {
    setTimeout(() => {
      bgMusic.play().catch(err => {
        console.error('Sync play failed:', err);
        musicPlaying = false;
        updatePlayBtn();
      });
    }, 100); // Small delay to ensure track is loaded
  } else {
    bgMusic.pause();
  }
  
  updatePlayBtn();
  
  // Show music bar if not already visible
  if (!musicEnabled) {
    musicEnabled = true;
    document.getElementById('musicBar').classList.remove('hidden');
    document.getElementById('musicToggleBtn').classList.add('active');
  }
}

// Music control button handlers
document.getElementById('playPauseBtn').onclick = () => {
  if (!isMusicLeader) {
    showToast('Only the room creator can control music');
    return;
  }
  toggleMusicPlayback();
  currentTrack = (currentTrack - 1 + TRACKS.length) % TRACKS.length;
  loadTrack(currentTrack, musicPlaying, 0);
  broadcastMusicState();
};

document.getElementById('prevTrackBtn').onclick = () => {
  if (!isMusicLeader) {
    showToast('Only the room creator can control music');
    return;
  }
  currentTrack = (currentTrack - 1 + TRACKS.length) % TRACKS.length;
  loadTrack(currentTrack, musicPlaying, 0);
  broadcastMusicState();
};

document.getElementById('nextTrackBtn').onclick = () => {
  if (!isMusicLeader) {
    showToast('Only the room creator can control music');
    return;
  }
  currentTrack = (currentTrack + 1) % TRACKS.length;
  loadTrack(currentTrack, musicPlaying, 0);
  broadcastMusicState();
};

document.getElementById('musicToggleBtn').onclick = () => {
  musicEnabled = !musicEnabled;
  const bar = document.getElementById('musicBar');
  const btn = document.getElementById('musicToggleBtn');
  
  if (musicEnabled) {
    bar.classList.remove('hidden');
    btn.classList.add('active');
    if (musicPlaying && bgMusic.src) {
      bgMusic.play().catch(err => console.error('Toggle play failed:', err));
    }
  } else {
    bar.classList.add('hidden');
    btn.classList.remove('active');
    bgMusic.pause();
  }
};

document.getElementById('musicVolBtn').onclick = () => {
  isMusicMuted = !isMusicMuted;
  bgMusic.volume = isMusicMuted ? 0 : 0.3;
  const volBtn = document.getElementById('musicVolBtn');
  const icon = volBtn.querySelector('i');
  if (icon) {
    icon.setAttribute('data-feather', isMusicMuted ? 'volume-x' : 'volume-2');
    feather.replace();
  } else {
    volBtn.innerHTML = `<i data-feather="${isMusicMuted ? 'volume-x' : 'volume-2'}"></i>`;
    feather.replace();
  }
};

// Progress bar click to seek
document.getElementById('musicProgress').onclick = (e) => {
  if (!isMusicLeader) {
    showToast('Only the room creator can control music');
    return;
  }
  
  const rect = e.currentTarget.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  if (bgMusic.duration && !isNaN(bgMusic.duration)) {
    bgMusic.currentTime = percent * bgMusic.duration;
    broadcastMusicState();
  }
};


// Sound
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playChime(freq=880, dur=0.18, type='sine') {
  if (isMuted) return;
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator(), gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type = type; osc.frequency.setValueAtTime(freq, ctx.currentTime);
    gain.gain.setValueAtTime(0.1, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + dur);
  } catch(e) {}
}
function playReceiveSound() { playChime(660, .14); setTimeout(() => playChime(880, .12), 80); }
function playSendSound() { playChime(1100, .09); }
function playJoinSound() { playChime(523,.18); setTimeout(() => playChime(659,.16), 110); setTimeout(() => playChime(784,.22), 220); }
function playRingSound() {
  if (isMuted) return;
  playChime(880,.15,'sine'); setTimeout(() => playChime(1109,.15,'sine'), 200);
}

function toggleMute() {
  isMuted = !isMuted;
  const muteBtn = document.getElementById('muteBtn');
  const icon = muteBtn.querySelector('i');
  if (icon) {
    icon.setAttribute('data-feather', isMuted ? 'volume-x' : 'volume-2');
    feather.replace();
  } else {
    muteBtn.innerHTML = `<i data-feather="${isMuted ? 'volume-x' : 'volume-2'}"></i>`;
    feather.replace();
  }
  showToast(isMuted ? 'üîá Notifications muted' : 'üîä Notifications on');
}

// Toast
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2400);
}

// DOM
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 96) + 'px';
}
function formatTime(ts) {
  const d = new Date(ts);
  return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
}
function addMessage({ id, text, isOut, senderName, senderAv, timestamp }) {
  const area = document.getElementById('messagesArea');
  const typing = document.getElementById('typingRow');
  const row = document.createElement('div');
  row.className = 'msg-row' + (isOut ? ' out' : '');
  row.dataset.msgId = id;
  if (!isOut) { const av = document.createElement('div'); av.className = 'msg-av'; av.textContent = senderAv || 'üíù'; row.appendChild(av); }
  const wrap = document.createElement('div'); wrap.className = 'bubble-wrap';
  if (!isOut) { const name = document.createElement('div'); name.className = 'sender-name'; name.textContent = senderName; wrap.appendChild(name); }
  const bubble = document.createElement('div'); bubble.className = 'bubble ' + (isOut ? 'out' : 'in');
  bubble.textContent = text;
  const meta = document.createElement('div'); meta.className = 'msg-meta';
  const tl = document.createElement('span'); tl.className = 'msg-time-label'; tl.textContent = formatTime(timestamp);
  meta.appendChild(tl);
  if (isOut) { const ck = document.createElement('span'); ck.className = 'checkmarks'; ck.id = 'ck-' + id; ck.textContent = '‚úì'; meta.appendChild(ck); }
  bubble.appendChild(meta); wrap.appendChild(bubble); row.appendChild(wrap);
  area.insertBefore(row, typing);
  area.scrollTop = area.scrollHeight;
}
function addSystemMsg(text) {
  const area = document.getElementById('messagesArea');
  const typing = document.getElementById('typingRow');
  const d = document.createElement('div'); d.className = 'sys-msg';
  d.innerHTML = `<span>${text}</span>`;
  area.insertBefore(d, typing);
  area.scrollTop = area.scrollHeight;
}
function setOnlineStatus(online) {
  const dot = document.getElementById('onlineDot');
  const av = document.getElementById('partnerAvatar');
  const st = document.getElementById('partnerStatus');
  partnerOnline = online;
  if (online) {
    dot.classList.add('show'); av.classList.add('online');
    st.textContent = 'Online'; st.className = 'partner-status online-text';
  } else {
    dot.classList.remove('show'); av.classList.remove('online');
    st.textContent = 'Offline'; st.className = 'partner-status';
  }
}

// Emoji
const emojiList = ['‚ù§Ô∏è','üíï','üíñ','üíó','üíì','üíù','üíû','üòç','ü•∞','üòò','üíã','üåπ','üå∏','üíê','üéÄ','‚ú®','üí´','‚≠ê','üåü','üéâ','üéä','ü•Ç','üçì','üç´','üïØÔ∏è','üåô','üåà','üòä','üòÇ','ü§ó','üòÖ','üôà','üíØ','üî•','üëë','üéÅ'];
const emojiGrid = document.getElementById('emojiGrid');
emojiList.forEach(e => {
  const d = document.createElement('div'); d.className = 'ep-emoji'; d.textContent = e;
  d.onclick = () => { const inp = document.getElementById('msgInput'); inp.value += e; inp.focus(); autoResize(inp); document.getElementById('emojiPanel').classList.remove('show'); };
  emojiGrid.appendChild(d);
});
document.getElementById('emojiToggleBtn').onclick = ev => { ev.stopPropagation(); document.getElementById('emojiPanel').classList.toggle('show'); };
document.addEventListener('click', () => document.getElementById('emojiPanel').classList.remove('show'));

// Join avatar picker
const joinAvatarList = ['ü•∞','üíù','üåπ','ü¶ã','üå∏','üê∞','üí´','üå∫','‚ú®','üéÄ'];
let joinSelectedAv = 'ü•∞';
const joinPicker = document.getElementById('joinAvatarPicker');
joinAvatarList.forEach((av, i) => {
  const btn = document.createElement('button'); btn.className = 'jav-btn' + (i===0?' active':'');
  btn.textContent = av;
  btn.onclick = () => { document.querySelectorAll('.jav-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); joinSelectedAv = av; };
  joinPicker.appendChild(btn);
});

// Video Call
let peerConn = null, localStream = null, callTimerInterval = null, callSeconds = 0;
let camEnabled = true, micEnabled = true, facingMode = 'user';
const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

async function getLocalStream() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30 } },
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
    });
    document.getElementById('localVideo').srcObject = localStream;
    if ('mediaDevices' in navigator && navigator.mediaDevices.getSupportedConstraints().facingMode) {
      document.getElementById('flipCamBtn').style.display = 'flex';
    }
    return true;
  } catch(e) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
      });
      document.getElementById('localVideo').srcObject = localStream;
      showToast('üìπ Using 720p');
      return true;
    } catch(e2) {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        showToast('üì∑ Audio only');
        return true;
      } catch(e3) { showToast('‚ùå Permission denied'); return false; }
    }
  }
}

async function switchCamera() {
  if (!localStream) return;
  facingMode = facingMode === 'user' ? 'environment' : 'user';
  const videoTrack = localStream.getVideoTracks()[0];
  if (videoTrack) videoTrack.stop();
  try {
    const newStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30 } },
      audio: false
    });
    const newVideoTrack = newStream.getVideoTracks()[0];
    const sender = peerConn.getSenders().find(s => s.track && s.track.kind === 'video');
    if (sender) sender.replaceTrack(newVideoTrack);
    localStream.removeTrack(videoTrack);
    localStream.addTrack(newVideoTrack);
    document.getElementById('localVideo').srcObject = localStream;
    showToast('üì∑ Camera switched');
  } catch(e) { showToast('‚ùå Camera switch failed'); }
}

function createPeerConnection() {
  if (peerConn) peerConn.close();
  peerConn = new RTCPeerConnection(iceServers);
  if (localStream) {
    localStream.getTracks().forEach(t => {
      const sender = peerConn.addTrack(t, localStream);
      if (t.kind === 'video') {
        const params = sender.getParameters();
        if (!params.encodings) params.encodings = [{}];
        params.encodings[0].maxBitrate = 2500000;
        sender.setParameters(params).catch(() => {});
      }
    });
  }
  peerConn.ontrack = e => {
    const remoteVideo = document.getElementById('remoteVideo');
    remoteVideo.srcObject = e.streams[0];
    remoteVideo.style.display = 'block';
    document.getElementById('remotePlaceholder').style.display = 'none';
  };
  peerConn.onicecandidate = e => {
    if (e.candidate) socket.emit('ice-candidate', { roomId, candidate: e.candidate });
  };
  peerConn.onconnectionstatechange = () => {
    if (peerConn && (peerConn.connectionState === 'disconnected' || peerConn.connectionState === 'failed')) endCall(false);
  };
}

function startCallTimer() {
  callSeconds = 0;
  clearInterval(callTimerInterval);
  callTimerInterval = setInterval(() => {
    callSeconds++;
    const m = Math.floor(callSeconds/60).toString().padStart(2,'0');
    const s = (callSeconds%60).toString().padStart(2,'0');
    document.getElementById('callTimer').textContent = m + ':' + s;
  }, 1000);
}

function showVideoCall() {
  document.getElementById('videoCallOverlay').classList.add('show');
  document.getElementById('callPartnerName').textContent = partnerName;
  document.getElementById('remoteAvEl').textContent = partnerAvEmoji;
  document.getElementById('remotePlaceholder').style.display = 'flex';
  document.getElementById('remoteVideo').style.display = 'none';
  document.getElementById('videoCallBtn').classList.add('video-active');
  startCallTimer();
  videoHeartInterval = setInterval(spawnVideoHeart, 800);
}

function endCall(notify = true) {
  if (notify && socket) socket.emit('call-ended', { roomId });
  if (peerConn) { peerConn.close(); peerConn = null; }
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  clearInterval(callTimerInterval);
  clearInterval(videoHeartInterval);
  document.getElementById('videoCallOverlay').classList.remove('show');
  document.getElementById('videoCallBtn').classList.remove('video-active');
  document.getElementById('localVideo').srcObject = null;
  document.getElementById('remoteVideo').srcObject = null;
  camEnabled = true; micEnabled = true; facingMode = 'user';
  document.getElementById('flipCamBtn').style.display = 'none';
  feather.replace();
  addSystemMsg('üìπ Video call ended');
}

document.getElementById('videoCallBtn').addEventListener('click', async () => {
  if (!partnerOnline) { showToast('‚ùå Partner offline'); return; }
  if (document.getElementById('videoCallOverlay').classList.contains('show')) { endCall(); return; }
  const ok = await getLocalStream();
  if (!ok) return;
  socket.emit('call-request', { roomId });
  document.getElementById('callingPulseAv').textContent = partnerAvEmoji;
  document.getElementById('callingName').textContent = partnerName;
  document.getElementById('callingModal').classList.add('show');
  playRingSound();
});

document.getElementById('cancelCallBtn').addEventListener('click', () => {
  socket.emit('call-cancelled', { roomId });
  document.getElementById('callingModal').classList.remove('show');
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
});

document.getElementById('acceptCallBtn').addEventListener('click', async () => {
  document.getElementById('incomingCallModal').classList.remove('show');
  const ok = await getLocalStream();
  if (!ok) return;
  socket.emit('call-accepted', { roomId });
  createPeerConnection();
  showVideoCall();
  addSystemMsg('üìπ Video call started');
});

document.getElementById('rejectCallBtn').addEventListener('click', () => {
  socket.emit('call-rejected', { roomId });
  document.getElementById('incomingCallModal').classList.remove('show');
  showToast('üìµ Call declined');
});

document.getElementById('endCallBtn').addEventListener('click', () => endCall());

document.getElementById('toggleCamBtn').addEventListener('click', () => {
  if (!localStream) return;
  const vid = localStream.getVideoTracks()[0];
  if (vid) { camEnabled = !camEnabled; vid.enabled = camEnabled; }
  const camBtn = document.getElementById('toggleCamBtn');
  const icon = camBtn.querySelector('i');
  if (icon) {
    icon.setAttribute('data-feather', camEnabled ? 'video' : 'video-off');
  } else {
    camBtn.innerHTML = `<i data-feather="${camEnabled ? 'video' : 'video-off'}"></i>`;
  }
  camBtn.classList.toggle('off', !camEnabled);
  socket.emit('toggle-video', { roomId, enabled: camEnabled });
  feather.replace();
});

document.getElementById('flipCamBtn').addEventListener('click', switchCamera);

document.getElementById('toggleMicBtn').addEventListener('click', () => {
  if (!localStream) return;
  const aud = localStream.getAudioTracks()[0];
  if (aud) { micEnabled = !micEnabled; aud.enabled = micEnabled; }
  const micBtn = document.getElementById('toggleMicBtn');
  const icon = micBtn.querySelector('i');
  if (icon) {
    icon.setAttribute('data-feather', micEnabled ? 'mic' : 'mic-off');
  } else {
    micBtn.innerHTML = `<i data-feather="${micEnabled ? 'mic' : 'mic-off'}"></i>`;
  }
  micBtn.classList.toggle('off', !micEnabled);
  socket.emit('toggle-audio', { roomId, enabled: micEnabled });
  feather.replace();
});

// Exit confirmation
let confirmingExit = false;
document.getElementById('backBtn').addEventListener('click', (e) => {
  e.preventDefault();
  if (partnerOnline && !confirmingExit) {
    document.getElementById('exitConfirmModal').classList.add('show');
  } else {
    window.location.href = '/';
  }
});

window.addEventListener('beforeunload', (e) => {
  if (partnerOnline && !confirmingExit) {
    e.preventDefault();
    e.returnValue = '';
    return '';
  }
});

document.getElementById('exitCancelBtn').addEventListener('click', () => {
  document.getElementById('exitConfirmModal').classList.remove('show');
});

document.getElementById('exitConfirmBtn').addEventListener('click', () => {
  confirmingExit = true;
  if (socket) socket.emit('leaving-room', { roomId });
  setTimeout(() => { window.location.href = '/'; }, 300);
});

// Init
window.addEventListener('load', () => {
  if (!roomId) { window.location.href = '/'; return; }
  document.getElementById('shareUrl').textContent = window.location.origin + '/room/' + roomId;

  if (isCreator) {
    document.getElementById('joinOverlay').classList.add('hidden');
    initSocket();
  } else {
    document.getElementById('joinOverlay').classList.remove('hidden');
    document.getElementById('joinBtn').addEventListener('click', () => {
      const n = document.getElementById('joinName').value.trim();
      if (!n) { document.getElementById('joinName').focus(); return; }
      myName = n; myAvatar = joinSelectedAv;
      document.getElementById('joinOverlay').classList.add('hidden');
      initSocket();
    });
    document.getElementById('joinName').addEventListener('keydown', e => { if (e.key==='Enter') document.getElementById('joinBtn').click(); });
  }
});

// Socket
function initSocket() {
  socket = io();

  socket.on('connect', () => {
    console.log('Socket connected');
    socket.emit('join-room', { roomId, userName: myName, avatar: myAvatar });
  });

  socket.on('joined-room', ({ userCount, isAlone, musicState }) => {
    console.log('Joined room:', { userCount, isAlone, musicState });
    
    if (isAlone) {
      document.getElementById('waitingOverlay').classList.remove('hidden');
      document.getElementById('partnerStatus').textContent = 'Waiting...';
      // Creator becomes music leader
      isMusicLeader = true;
      console.log('I am the music leader (creator)');
    } else {
      document.getElementById('waitingOverlay').classList.add('hidden');
      // Guest receives music sync
      isMusicLeader = false;
      console.log('I am a guest, will sync to leader');
      if (musicState) {
        applyMusicSync(musicState);
      }
    }
  });

  socket.on('partner-already-here', ({ name, avatar, musicState }) => {
    console.log('Partner already here:', { name, avatar, musicState });
    partnerName = name; partnerAvEmoji = avatar;
    document.getElementById('partnerName').textContent = name;
    document.getElementById('partnerAvatar').textContent = avatar;
    document.getElementById('typingAv').textContent = avatar;
    document.getElementById('remoteAvEl').textContent = avatar;
    setOnlineStatus(true);
    document.getElementById('waitingOverlay').classList.add('hidden');
    addSystemMsg('üíï Both of you are here!');
    playJoinSound();
    
    // Guest syncs to creator's music
    isMusicLeader = false;
    if (musicState) {
      applyMusicSync(musicState);
    }
  });

  socket.on('partner-joined', ({ name, avatar }) => {
    console.log('Partner joined:', { name, avatar });
    partnerName = name; partnerAvEmoji = avatar;
    document.getElementById('partnerName').textContent = name;
    document.getElementById('partnerAvatar').textContent = avatar;
    document.getElementById('typingAv').textContent = avatar;
    document.getElementById('remoteAvEl').textContent = avatar;
    setOnlineStatus(true);
    document.getElementById('waitingOverlay').classList.add('hidden');
    addSystemMsg(`üíï ${name} joined`);
    playJoinSound();
    showToast(`üíï ${name} is here!`);
    
    // Show music bar for both users
    document.getElementById('musicBar').classList.remove('hidden');
    document.getElementById('musicToggleBtn').classList.add('active');
    musicEnabled = true;
    
    // If I'm the leader, load first track and broadcast state
    if (isMusicLeader) {
      loadTrack(0, false, 0);
      broadcastMusicState();
    }
  });

  socket.on('partner-left', ({ name }) => {
    setOnlineStatus(false);
    addSystemMsg(`üíî ${name} left`);
    showToast(`üíî ${name} left`);
    document.getElementById('typingRow').classList.remove('show');
    if (document.getElementById('videoCallOverlay').classList.contains('show')) endCall(false);
  });

  socket.on('partner-ended-chat', ({ name }) => {
    addSystemMsg(`üíî This chat has been ended by ${name}`);
    showToast('üíî Chat ended');
    setTimeout(() => { window.location.href = '/'; }, 3000);
  });

  socket.on('receive-message', ({ from, avatar, message, timestamp, msgId }) => {
    addMessage({ id: msgId, text: message, isOut: false, senderName: from, senderAv: avatar, timestamp });
    socket.emit('message-seen', { roomId, msgId });
    playReceiveSound();
    showToast(`${avatar} ${from}: ${message.length > 28 ? message.slice(0,28)+'...' : message}`);
  });

  socket.on('partner-typing', ({ isTyping }) => {
    document.getElementById('typingRow').classList.toggle('show', isTyping);
    if (isTyping) document.getElementById('messagesArea').scrollTop = 9999999;
  });

  socket.on('message-seen', ({ msgId }) => {
    const ck = document.getElementById('ck-' + msgId);
    if (ck) { ck.textContent = '‚úì‚úì'; ck.classList.add('seen'); }
  });

  socket.on('room-full', () => { document.getElementById('roomFullOverlay').classList.add('show'); });

  socket.on('ip-already-connected', () => {
    document.getElementById('ipBlockedOverlay').classList.add('show');
  });

  socket.on('music-sync', (data) => {
    console.log('Received music sync:', data);
    if (isMusicLeader) {
      console.log('Ignoring sync - I am the leader');
      return; // Leader doesn't sync to followers
    }
    applyMusicSync(data);
  });

  socket.on('music-control', (data) => {
    console.log('Received music control:', data);
    if (isMusicLeader) {
      console.log('Ignoring control - I am the leader');
      return; // Leader doesn't listen to control messages
    }
    applyMusicSync(data);
  });

  socket.on('call-incoming', ({ from, avatar, callerId: cid }) => {
    callerId = cid;
    document.getElementById('callerAvatar').textContent = avatar;
    document.getElementById('callerName').textContent = from;
    document.getElementById('incomingCallModal').classList.add('show');
    playRingSound();
    showToast(`üìπ ${from} is calling...`);
  });

  socket.on('call-cancelled', () => {
    document.getElementById('incomingCallModal').classList.remove('show');
    showToast('üìµ Call was cancelled');
  });

  socket.on('call-accepted', async () => {
    document.getElementById('callingModal').classList.remove('show');
    createPeerConnection();
    const offer = await peerConn.createOffer();
    await peerConn.setLocalDescription(offer);
    socket.emit('video-offer', { roomId, offer });
    showVideoCall();
    addSystemMsg('üìπ Video call started');
  });

  socket.on('call-rejected', () => {
    document.getElementById('callingModal').classList.remove('show');
    if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
    showToast('üìµ Call declined');
  });

  socket.on('call-ended', () => {
    document.getElementById('incomingCallModal').classList.remove('show');
    document.getElementById('callingModal').classList.remove('show');
    if (document.getElementById('videoCallOverlay').classList.contains('show')) endCall(false);
  });

  socket.on('video-offer', async ({ offer }) => {
    createPeerConnection();
    await peerConn.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConn.createAnswer();
    await peerConn.setLocalDescription(answer);
    socket.emit('video-answer', { roomId, answer });
  });

  socket.on('video-answer', async ({ answer }) => {
    if (peerConn) await peerConn.setRemoteDescription(new RTCSessionDescription(answer));
  });

  socket.on('ice-candidate', async ({ candidate }) => {
    try { if (peerConn && candidate) await peerConn.addIceCandidate(new RTCIceCandidate(candidate)); } catch(e) {}
  });

  socket.on('remote-toggle-video', ({ enabled }) => {
    showToast(enabled ? `${partnerAvEmoji} Camera on` : `${partnerAvEmoji} Camera off`);
  });

  socket.on('remote-toggle-audio', ({ enabled }) => {
    showToast(enabled ? `${partnerAvEmoji} Mic on` : `${partnerAvEmoji} Mic muted`);
  });

  document.getElementById('copyShareLink').addEventListener('click', () => {
    const url = window.location.origin + '/room/' + roomId;
    const textToCopy = `Will you be my Valentine? üíñ
I found this cute secret chat app and thought of you‚Ä¶  
Come join me, I‚Äôm waiting üòçüòâ  

${url}`;

    navigator.clipboard.writeText(textToCopy).then(() => {
      document.getElementById('copyShareLink').textContent = '‚úÖ Copied!';
      setTimeout(() => document.getElementById('copyShareLink').textContent = 'üìã Copy Link', 2000);
    }).catch(() => showToast('‚ùå Copy failed'));
  });
}

// Send message
function sendMessage() {
  const inp = document.getElementById('msgInput');
  const text = inp.value.trim();
  if (!text || !socket) return;
  const msgId = Date.now() + '-' + Math.random().toString(36).substr(2,5);
  const ts = Date.now();
  socket.emit('send-message', { roomId, message: text, timestamp: ts, msgId });
  addMessage({ id: msgId, text, isOut: true, senderName: myName, senderAv: myAvatar, timestamp: ts });
  playSendSound();
  inp.value = ''; inp.style.height = 'auto';
  socket.emit('typing', { roomId, isTyping: false });
  clearTimeout(typingTimer); isTypingNow = false;
}

const msgInput = document.getElementById('msgInput');
msgInput.addEventListener('input', () => {
  autoResize(msgInput);
  if (!socket) return;
  if (!isTypingNow) { isTypingNow = true; socket.emit('typing', { roomId, isTyping: true }); }
  clearTimeout(typingTimer);
  typingTimer = setTimeout(() => { isTypingNow = false; socket.emit('typing', { roomId, isTyping: false }); }, 1800);
});
msgInput.addEventListener('keydown', e => { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('muteBtn').addEventListener('click', toggleMute);

// Initialize Feather Icons
feather.replace();
</script>
</body>
</html>